// ==UserScript==
// @name         ZZZ Seelie 数据同步
// @namespace    github.com/owwkmidream
// @version      1.2.2.2-gfecabc1
// @author       owwkmidream
// @description  绝区零 Seelie 网站数据同步脚本
// @license      MIT
// @icon         https://zzz.seelie.me/img/logo.svg
// @homepageURL  https://github.com/owwkmidream/zzz-seelie-sync
// @supportURL   https://github.com/owwkmidream/zzz-seelie-sync/issues
// @downloadURL  https://fastgh.lainbo.com/https://raw.githubusercontent.com/owwkmidream/zzz-seelie-sync/refs/heads/release-nightly/zzz-seelie-sync.mini.user.js
// @updateURL    https://fastgh.lainbo.com/https://raw.githubusercontent.com/owwkmidream/zzz-seelie-sync/refs/heads/release-nightly/zzz-seelie-sync.mini.meta.js
// @match        https://zzz.seelie.me/*
// @match        https://do-not-exist.mihoyo.com/
// @connect      act-api-takumi.mihoyo.com
// @connect      api-takumi-record.mihoyo.com
// @connect      public-data-api.mihoyo.com
// @connect      api-takumi.mihoyo.com
// @grant        GM.cookie
// @grant        GM.xmlHttpRequest
// @run-at       document-end
// ==/UserScript==

(function () {
    'use strict';

    class L{prefix;timestamp;showLocation;colors;fileColorMap=new Map;constructor(e={}){this.prefix=e.prefix||"[zzz-seelie-sync]",this.timestamp=e.timestamp??true,this.showLocation=e.showLocation??true,this.colors={log:"#333333",info:"#2196F3",warn:"#FF9800",error:"#F44336",debug:"#9C27B0",...e.colors};}generateRandomColor(){const e=["#E91E63","#9C27B0","#673AB7","#3F51B5","#2196F3","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFC107","#FF9800","#FF5722","#795548","#607D8B","#E53935","#D81B60","#8E24AA","#5E35B1"];return e[Math.floor(Math.random()*e.length)]}getFileColor(e){return this.fileColorMap.has(e)||this.fileColorMap.set(e,this.generateRandomColor()),this.fileColorMap.get(e)}getLocationInfo(){try{const e=new Error().stack;if(!e)return null;const t=e.split(`
`);for(let r=3;r<Math.min(t.length,8);r++){const s=t[r];if(!s||s.includes("Logger.")||s.includes("formatMessage")||s.includes("getLocationInfo"))continue;const a=[/at.*?\((.+):(\d+):(\d+)\)/,/at\s+(.+):(\d+):(\d+)/,/@(.+):(\d+):(\d+)/,/(.+):(\d+):(\d+)$/];for(const i of a){const c=s.match(i);if(c){const l=c[1],d=parseInt(c[2],10),u=parseInt(c[3],10);if(!l||l.includes("chrome-extension://")||l.includes("moz-extension://"))continue;const h=l.split("/").pop()||l.split("\\").pop()||l;if(h&&!isNaN(d)&&!isNaN(u))return {fileName:h,lineNumber:d,columnNumber:u}}}}return null}catch{return null}}formatMessage(e,t,...r){const s=this.timestamp?`[${new Date().toLocaleTimeString()}]`:"",a=this.showLocation?this.getLocationInfo():null;let i=`${s} ${this.prefix} [${e.toUpperCase()}]`,c="",l="";return a&&(c=` [${a.fileName}:${a.lineNumber}]`,l=this.getFileColor(a.fileName)),typeof window<"u"?a?[`%c${i}%c${c}`,`color: ${t}; font-weight: bold;`,`color: ${l}; font-weight: bold; font-style: italic;`,...r]:[`%c${i}`,`color: ${t}; font-weight: bold;`,...r]:[i+c,...r]}log(...e){console.log(...this.formatMessage("log",this.colors.log,...e));}info(...e){console.info(...this.formatMessage("info",this.colors.info,...e));}warn(...e){console.warn(...this.formatMessage("warn",this.colors.warn,...e));}error(...e){console.error(...this.formatMessage("error",this.colors.error,...e));}debug(...e){}table(e,t){(this.timestamp||this.prefix)&&this.info("Table data:"),console.table(e,t);}group(e){const t=e?this.formatMessage("group",this.colors.info,e)[2]:void 0;console.group(t);}groupCollapsed(e){const t=e?this.formatMessage("group",this.colors.info,e)[2]:void 0;console.groupCollapsed(t);}groupEnd(){console.groupEnd();}time(e){console.time(e);}timeEnd(e){console.timeEnd(e);}clear(){console.clear();}createChild(e,t){const r=new L({prefix:`${this.prefix}:${e}`,timestamp:this.timestamp,showLocation:this.showLocation,colors:this.colors,...t});return r.fileColorMap=this.fileColorMap,r}}const n=new L({prefix:"[Seelie]",timestamp:true,showLocation:true,colors:{log:"#4CAF50",info:"#2196F3",warn:"#FF9800",error:"#F44336",debug:"#9C27B0"}});n.log.bind(n);n.info.bind(n);n.warn.bind(n);n.error.bind(n);let I=[],E=null,R=false;function P(){const o=document.querySelector("#app");if(!o?.__vue_app__)return n.debug("🔍 未找到 Vue App 实例，可能还在加载中..."),null;n.debug("🔍 查找 Vue Router 实例...");const e=o.__vue_app__.config?.globalProperties?.$router;if(e&&typeof e.afterEach=="function"&&typeof e.beforeEach=="function"&&typeof e.push=="function")return n.info("✓ 从 __vue_app__.config.globalProperties.$router 找到 Router 实例"),n.debug("Router 实例:",e),e;const t=o.__vue_app__._context;if(t?.provides){n.debug("🔍 尝试从 provides 查找 Router...");const r=t.provides,s=Object.getOwnPropertySymbols(r);for(const a of s){const i=r[a];if(i&&typeof i=="object"){const c=i;if(typeof c.afterEach=="function"&&typeof c.beforeEach=="function"&&typeof c.push=="function")return n.info("✓ 从 provides 找到 Router 实例:",a.toString()),n.debug("Router 实例:",i),c}}}return n.debug("🔍 未找到 Vue Router 实例，可能还在初始化中..."),null}function H(){E&&(E.disconnect(),E=null),R=false;}function re(){R||E||(n.debug("👀 启动 Vue Router 观察器..."),R=true,E=new MutationObserver(()=>{const e=P();e&&(n.info("✓ Vue Router 已加载，处理待注册的 Hook..."),H(),G(e));}),E.observe(document.querySelector("#app"),{childList:false,subtree:false,attributes:true}),setTimeout(()=>{R&&(n.warn("⚠️ Vue Router 观察器超时，停止观察"),H(),G(null));},3e3));}function G(o){n.debug(`🔄 处理 ${I.length} 个待注册的 Hook...`);const e=[...I];I=[],e.forEach(({callback:t,options:r,unwatchRef:s})=>{if(o){const{unwatch:a}=K(o,t,r);s.current=a;}else n.warn("⚠️ Vue Router 未找到，Hook 注册失败"),s.current=()=>{};});}function K(o,e,t){const{delay:r=100,immediate:s=false}=t;s&&setTimeout(()=>{const i=o.currentRoute?.value||o.currentRoute;e(i,null);},r);const a=o.afterEach((i,c)=>{n.debug("🔄 路由变化检测到:",c?.path,"->",i?.path),setTimeout(()=>{e(i,c);},r);});return {router:o,unwatch:a,getCurrentRoute:()=>o.currentRoute?.value||o.currentRoute}}function ne(o,e={}){n.debug("🚦 设置路由监听 Hook...");const t=P();if(t)return n.debug("✓ Vue Router 已存在，直接注册 Hook"),K(t,o,e);n.debug("⏳ Vue Router 未找到，设置延迟注册...");const r={current:null};return I.push({callback:o,options:e,unwatchRef:r}),re(),{router:null,unwatch:()=>{r.current&&r.current();},getCurrentRoute:()=>{const s=P();if(s)return s.currentRoute?.value||s.currentRoute}}}class se{component=null;config;factory;isCreating=false;createPromise=null;constructor(e,t){this.config=e,this.factory=t;}checkExistence(){const e=document.querySelector(this.config.targetSelector);return e?e.querySelector(this.config.componentSelector)!==null:false}checkCondition(){if(!(document.querySelector(this.config.targetSelector)!==null)||this.config.condition&&!this.config.condition())return  false;if(this.config.routePattern){const t=window.location.pathname;return typeof this.config.routePattern=="string"?t.includes(this.config.routePattern):this.config.routePattern.test(t)}return  true}async tryCreate(){if(this.isCreating&&this.createPromise){n.debug(`⏳ [${this.config.id}] 组件正在创建中，等待完成`),await this.createPromise;return}if(!this.checkCondition()){n.debug(`🚫 [${this.config.id}] 条件检查失败，跳过创建`);return}if(this.checkExistence()){n.debug(`✅ [${this.config.id}] 组件已存在，跳过创建`);return}this.createPromise=this.createComponent(),await this.createPromise;}async createComponent(){if(this.isCreating){n.debug(`⚠️ [${this.config.id}] 组件已在创建中，跳过重复创建`);return}this.isCreating=true;try{if(this.checkExistence()){n.debug(`✅ [${this.config.id}] 组件已存在，取消创建`);return}this.destroyComponent(),this.component=await this.factory(),await this.component.init(),n.debug(`✅ [${this.config.id}] 组件创建成功`);}catch(e){n.error(`❌ [${this.config.id}] 创建组件失败:`,e),this.component=null;}finally{this.isCreating=false,this.createPromise=null;}}async checkAndRecreate(){if(this.isCreating){n.debug(`⏳ [${this.config.id}] 组件正在创建中，跳过检查`);return}const e=this.checkCondition(),t=this.checkExistence();e&&!t?(n.debug(`🔧 [${this.config.id}] 组件缺失，重新创建组件`),await this.tryCreate()):!e&&t&&(n.debug(`🗑️ [${this.config.id}] 条件不满足，销毁组件`),this.destroyComponent());}destroyComponent(){if(this.isCreating&&this.createPromise){n.debug(`⏳ [${this.config.id}] 等待创建完成后销毁`),this.createPromise.then(()=>{this.component&&(this.component.destroy(),this.component=null,n.debug(`🗑️ [${this.config.id}] 组件已销毁（延迟）`));});return}this.component&&(this.component.destroy(),this.component=null,n.debug(`🗑️ [${this.config.id}] 组件已销毁`));}async refreshComponent(){this.component&&this.component.refresh&&(await this.component.refresh(),n.debug(`🔄 [${this.config.id}] 组件已刷新`));}async handleRouteChange(e,t){await this.checkAndRecreate();}async handleDOMChange(e){await this.checkAndRecreate();}cleanup(){this.isCreating=false,this.createPromise=null,this.destroyComponent();}getComponent(){return this.component}hasComponent(){return this.component!==null&&this.checkExistence()}isCreatingComponent(){return this.isCreating}getConfig(){return this.config}}class oe{injectors=new Map;domObserver=null;routerUnwatch=null;isInitialized=false;options;constructor(e={}){this.options={observerConfig:{childList:true,subtree:true},enableGlobalRouterWatch:true,routerDelay:100,...e};}register(e,t){this.injectors.has(e.id)&&(n.warn(`⚠️ 注入器 [${e.id}] 已存在，将被覆盖`),this.unregister(e.id));const r=new se(e,t);return this.injectors.set(e.id,r),n.debug(`📝 注册组件注入器: [${e.id}]`),this.isInitialized&&r.tryCreate(),r}unregister(e){const t=this.injectors.get(e);return t?(t.cleanup(),this.injectors.delete(e),n.debug(`🗑️ 注销组件注入器: [${e}]`),true):false}getInjector(e){return this.injectors.get(e)||null}init(){if(this.isInitialized){n.warn("⚠️ DOM 注入管理器已经初始化");return}n.debug("🎯 初始化 DOM 注入管理器"),this.options.enableGlobalRouterWatch&&this.setupGlobalRouterWatcher(),this.setupDOMObserver(),this.createAllComponents(),this.isInitialized=true;}setupGlobalRouterWatcher(){const{unwatch:e}=ne(async(t,r)=>{n.debug("🔄 全局路由变化检测到:",r?.path,"->",t?.path),await this.handleGlobalRouteChange(t,r);},{delay:this.options.routerDelay,immediate:false});this.routerUnwatch=e,n.debug("✅ 全局路由监听设置完成");}setupDOMObserver(){let e=null,t=false,r=[],s=0;const a=3e3;this.domObserver=new MutationObserver(async i=>{r.push(...i),e&&clearTimeout(e),e=setTimeout(async()=>{if(t){n.debug("🔍 DOM 变化处理中，跳过本次处理");return}t=true;const c=[...r];r=[];try{const l=Date.now();l-s>=a&&(s=l,n.debug(`🔍 检测到 ${c.length} 个 DOM 变化，通知所有组件`)),await this.handleGlobalDOMChange(c);}finally{t=false,e=null;}},100);}),this.domObserver.observe(document.body,this.options.observerConfig),n.debug("✅ DOM 观察器设置完成");}async handleGlobalRouteChange(e,t){const r=Array.from(this.injectors.values()).map(s=>s.handleRouteChange(e,t));await Promise.allSettled(r);}async handleGlobalDOMChange(e){const t=Array.from(this.injectors.values()).map(r=>r.handleDOMChange(e));await Promise.allSettled(t);}async createAllComponents(){const e=Array.from(this.injectors.values()).map(t=>t.tryCreate());await Promise.allSettled(e);}async refreshAllComponents(){const e=Array.from(this.injectors.values()).map(t=>t.refreshComponent());await Promise.allSettled(e);}async refreshComponent(e){const t=this.injectors.get(e);t&&await t.refreshComponent();}destroy(){n.debug("🗑️ 销毁 DOM 注入管理器");for(const e of this.injectors.values())e.cleanup();this.injectors.clear(),this.routerUnwatch&&(this.routerUnwatch(),this.routerUnwatch=null),this.domObserver&&(this.domObserver.disconnect(),this.domObserver=null),this.isInitialized=false;}getInjectorIds(){return Array.from(this.injectors.keys())}getInjectorCount(){return this.injectors.size}isInit(){return this.isInitialized}}const N=new oe({enableGlobalRouterWatch:true,routerDelay:200,observerConfig:{childList:true,subtree:true}});function ae(o){const e=o.trim();if(!e)return new Headers;const t=e.split(`\r
`).map(r=>{let s=r.split(":");return [s[0].trim(),s[1].trim()]});return new Headers(t)}function ie(o,e){const t=ae(e.responseHeaders),r=typeof e.response=="string"?new Blob([e.response],{type:t.get("Content-Type")||"text/plain"}):e.response;return new U(r,{statusCode:e.status,statusText:e.statusText,headers:t,finalUrl:e.finalUrl,redirected:e.finalUrl===o.url})}class U{constructor(e,t){this.rawBody=e,this.init=t,this.body=e.stream();const{headers:r,statusCode:s,statusText:a,finalUrl:i,redirected:c}=t;this.headers=r,this.status=s,this.statusText=a,this.url=i,this.type="basic",this.redirected=c,this._bodyUsed=false;}get bodyUsed(){return this._bodyUsed}get ok(){return this.status<300}arrayBuffer(){if(this.bodyUsed)throw new TypeError("Failed to execute 'arrayBuffer' on 'Response': body stream already read");return this._bodyUsed=true,this.rawBody.arrayBuffer()}blob(){if(this.bodyUsed)throw new TypeError("Failed to execute 'blob' on 'Response': body stream already read");return this._bodyUsed=true,Promise.resolve(this.rawBody.slice(0,this.rawBody.size,this.rawBody.type))}clone(){if(this.bodyUsed)throw new TypeError("Failed to execute 'clone' on 'Response': body stream already read");return new U(this.rawBody,this.init)}formData(){if(this.bodyUsed)throw new TypeError("Failed to execute 'formData' on 'Response': body stream already read");return this._bodyUsed=true,this.rawBody.text().then(ce)}async json(){if(this.bodyUsed)throw new TypeError("Failed to execute 'json' on 'Response': body stream already read");return this._bodyUsed=true,JSON.parse(await this.rawBody.text())}text(){if(this.bodyUsed)throw new TypeError("Failed to execute 'text' on 'Response': body stream already read");return this._bodyUsed=true,this.rawBody.text()}async bytes(){if(this.bodyUsed)throw new TypeError("Failed to execute 'bytes' on 'Response': body stream already read");return this._bodyUsed=true,new Uint8Array(await this.rawBody.arrayBuffer())}}function ce(o){const e=new FormData;return o.trim().split("&").forEach(function(t){if(t){const r=t.split("="),s=r.shift()?.replace(/\+/g," "),a=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(s),decodeURIComponent(a));}}),e}async function $(o,e){const t=new Request(o,e);let r;return e?.body&&(r=await t.text()),await le(t,e,r)}function le(o,e,t){return new Promise((r,s)=>{if(o.signal&&o.signal.aborted)return s(new DOMException("Aborted","AbortError"));GM.xmlHttpRequest({url:o.url,method:he(o.method.toUpperCase()),headers:Object.fromEntries(new Headers(e?.headers).entries()),data:t,responseType:"blob",onload(a){try{r(ie(o,a));}catch(i){s(i);}},onabort(){s(new DOMException("Aborted","AbortError"));},ontimeout(){s(new TypeError("Network request failed, timeout"));},onerror(a){s(new TypeError("Failed to fetch: "+a.finalUrl));}});})}const ue=["GET","POST","PUT","DELETE","PATCH","HEAD","TRACE","OPTIONS","CONNECT"];function de(o,e){return o.includes(e)}function he(o){if(de(ue,o))return o;throw new Error(`unsupported http method ${o}`)}var fe=typeof GM<"u"?GM:void 0;const q="zzz_device_info",k="https://act-api-takumi.mihoyo.com/event/nap_cultivate_tool",pe="https://api-takumi-record.mihoyo.com/event/game_record_zzz/api/zzz",me="https://public-data-api.mihoyo.com/device-fp/api/getFp",ge="https://api-takumi.mihoyo.com/binding/api/getUserGameRolesByCookie?game_biz=nap_cn",ye="https://api-takumi.mihoyo.com/common/badge/v1/login/account";let F=false,C=null,w={deviceId:X(),deviceFp:"0000000000000",timestamp:Date.now()},_=null;const J="2.85.1",D={Accept:"application/json","User-Agent":`Mozilla/5.0 (Linux; Android 13; Pixel 5 Build/TQ3A.230901.001; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/118.0.0.0 Mobile Safari/537.36 miHoYoBBS/${J}`};async function we(){const o=await ee();return {...D,Referer:"https://act.mihoyo.com/","x-rpc-app_version":J,"x-rpc-client_type":"5","x-rpc-device_fp":o.deviceFp,"x-rpc-device_id":o.deviceId}}async function Z(){if(!F){n.debug("🔄 初始化 nap_token cookie...");try{const o=await $(ge,{method:"GET",headers:D});if(!o.ok)throw new Error(`获取用户角色失败: HTTP ${o.status}`);const e=await o.json();if(e.retcode!==0)throw new Error(`获取用户角色失败: ${e.message}`);if(!e.data?.list||e.data.list.length===0)throw new Error("未找到绝区零游戏角色");const t=e.data.list[0];n.debug(`🎮 找到角色: ${t.nickname} (UID: ${t.game_uid}, 等级: ${t.level})`);const r=await $(ye,{method:"POST",headers:{"Content-Type":"application/json",...D},body:JSON.stringify({region:t.region,uid:t.game_uid,game_biz:t.game_biz})});if(!r.ok)throw new Error(`设置 nap_token 失败: HTTP ${r.status}`);const s=await r.json();if(s.retcode!==0)throw new Error(`设置 nap_token 失败: ${s.message}`);C={uid:t.game_uid,nickname:t.nickname,level:t.level,region:t.region,accountId:t.game_uid},n.debug("✅ nap_token cookie 初始化完成"),n.info(`👤 用户信息: ${C.nickname} (UID: ${C.uid}, 等级: ${C.level})`),F=!0;}catch(o){throw n.error("❌ 初始化 nap_token 失败:",o),o}}}async function Y(){C||await Z();}async function A(o,e,t={}){const{method:r="GET",params:s={},body:a,headers:i={}}=t;e===k&&await Z();let c=`${e}${o}`;if(Object.keys(s).length>0){const u=new URLSearchParams;Object.entries(s).forEach(([h,g])=>{u.append(h,String(g));}),c+=`?${u.toString()}`;}const l=[1034,5003,10035,10041,10053],d=async(u=false)=>{const g={...await we(),...i};if(g["x-rpc-device_fp"]==="0000000000000")throw new Error("❌ 设备指纹有误，请检查");n.debug(`🌐 请求 ${r} ${c}${u?" (重试)":""}`);try{const p=[c,{method:r,headers:g,body:a?JSON.stringify(a):void 0}],m=await $(...p);if(!m.ok)throw new Error(`HTTP ${m.status}: ${m.statusText}`);const y=await m.json();if(y.retcode!==0){if(l.includes(y.retcode)&&!u){n.warn(`⚠️ 检测到设备指纹错误码 ${y.retcode}: ${y.message}，正在刷新设备指纹...`);try{return await Q(),n.debug("✅ 设备指纹刷新完成，准备重试请求"),await d(!0)}catch(te){throw n.error("❌ 设备指纹刷新失败:",te),new Error(`设备指纹刷新失败，原始错误: API Error ${y.retcode}: ${y.message}`)}}throw n.error(`❌ 请求失败
请求:`,p,`
响应：`,m,y),new Error(`API Error ${y.retcode}: ${y.message}`)}return n.debug(`✅ 请求成功: ${p[0]}, ${y.retcode}: ${y.message}`),y}catch(p){throw p instanceof Error&&p.message.includes("API Error")||n.error("❌ 请求失败:",p),p}};return await d()}async function Q(){const o=await fe.cookie.list({url:"https://do-not-exist.mihoyo.com/"});if(o.length!==0)for(const r of o)r.name==="_MHYUUID"&&(n.debug("🔐 从米游社获取到UUID",r.value),w.deviceId=r.value);if(!w)throw new Error("设备信息缓存未初始化");const e=be(),t={device_id:ve(),seed_id:X(),seed_time:Date.now().toString(),platform:"2",device_fp:w.deviceFp,app_name:"bbs_cn",ext_fields:`{"proxyStatus":0,"isRoot":0,"romCapacity":"512","deviceName":"Pixel5","productName":"${e}","romRemain":"512","hostname":"db1ba5f7c000000","screenSize":"1080x2400","isTablet":0,"aaid":"","model":"Pixel5","brand":"google","hardware":"windows_x86_64","deviceType":"redfin","devId":"REL","serialNumber":"unknown","sdCapacity":125943,"buildTime":"1704316741000","buildUser":"cloudtest","simState":0,"ramRemain":"124603","appUpdateTimeDiff":1716369357492,"deviceInfo":"google\\/${e}\\/redfin:13\\/TQ3A.230901.001\\/2311.40000.5.0:user\\/release-keys","vaid":"","buildType":"user","sdkVersion":"33","ui_mode":"UI_MODE_TYPE_NORMAL","isMockLocation":0,"cpuType":"arm64-v8a","isAirMode":0,"ringMode":2,"chargeStatus":3,"manufacturer":"Google","emulatorStatus":0,"appMemory":"512","osVersion":"13","vendor":"unknown","accelerometer":"","sdRemain":123276,"buildTags":"release-keys","packageName":"com.mihoyo.hyperion","networkType":"WiFi","oaid":"","debugStatus":1,"ramCapacity":"125943","magnetometer":"","display":"TQ3A.230901.001","appInstallTimeDiff":1706444666737,"packageVersion":"2.20.2","gyroscope":"","batteryStatus":85,"hasKeyboard":10,"board":"windows"}`,bbs_device_id:w.deviceId};n.debug(`🔐 获取设备指纹，设备ID: ${w.deviceId}`);try{const r=await $(`${me}`,{method:"POST",headers:{...D,"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const s=await r.json();if(s.retcode!==0||s.data.code!==200)throw new Error(`设备指纹获取失败 ${s.retcode}: ${s.message}`);w.deviceFp=s.data.device_fp,w.timestamp=Date.now(),localStorage.setItem(q,JSON.stringify(w)),n.debug(`✅ 设备指纹获取成功并更新缓存: ${s.data.device_fp}`);}catch(r){throw n.error("❌ 设备指纹获取失败:",r),r}}function be(){const o="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let e="";for(let t=0;t<6;t++)e+=o[Math.floor(Math.random()*o.length)];return e}function X(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){const e=Math.random()*16|0;return (o==="x"?e:e&3|8).toString(16)})}function ve(){return xe(16)}function xe(o){const e=new Uint8Array(Math.ceil(o/2));if(typeof crypto<"u"&&crypto.getRandomValues)crypto.getRandomValues(e);else for(let r=0;r<e.length;r++)e[r]=Math.floor(Math.random()*256);return Array.from(e,r=>r.toString(16).padStart(2,"0")).join("").substring(0,o)}async function ee(o){if(_)return _;_=(async()=>{const t=localStorage.getItem(q);if(t)try{const s=JSON.parse(t);n.debug("📱 从localStorage获取设备信息:",s),w=s;}catch(s){n.warn("⚠️ 解析设备信息失败，将重新生成:",s);}let r=false;if(o===true)r=true,n.debug("📱 强制刷新设备指纹");else if(o===false)r=false,n.debug("📱 跳过设备指纹刷新");else {const s=Date.now(),a=4320*60*1e3;w.deviceFp==="0000000000000"?(r=true,n.debug("📱 设备指纹为初始值，需要获取真实指纹")):s-w.timestamp>a?(r=true,n.debug("📱 设备信息超过3天，需要刷新")):n.debug("📱 设备信息仍在有效期内");}if(r)try{await Q(),n.debug("✅ 设备指纹刷新完成");}catch(s){throw n.error("❌ 设备指纹刷新失败:",s),s}return w})();const e=await _;return _=null,e}function Ce(){return C}async function Se(){return await Y(),C}async function Ee(){n.debug("🔄 开始刷新设备信息...");const o=await ee(true);n.debug("✅ 设备信息刷新完成:",o);}async function T(o,e){await Y();const t=Ce();if(t)return {uid:t.uid,region:e||t.region};throw new Error("❌ 未提供 UID 且无法从缓存获取用户信息，请确保已登录米游社")}async function _e(o,e,t){if(o.length<=e)return t(o);const r=[];for(let i=0;i<o.length;i+=e)r.push(o.slice(i,i+e));const s=r.map(i=>t(i));return (await Promise.all(s)).flat()}async function $e(o,e){const t=await T(o,e);return (await A("/user/avatar_basic_list",k,{method:"GET",params:{uid:t.uid,region:t.region}})).data.list.filter(s=>s.unlocked===true)}async function z(o,e,t){const r=await T(e,t),s=typeof o[0]=="number"?o.map(a=>({avatar_id:a,is_teaser:false,teaser_need_weapon:false,teaser_sp_skill:false})):o;return _e(s,10,async a=>(await A("/user/batch_avatar_detail_v2",k,{method:"POST",params:{uid:r.uid,region:r.region},body:{avatar_list:a}})).data.list)}async function Ie(o,e){const t=await T(o,e);return (await A("/note",pe,{method:"GET",params:{server:t.region,role_id:t.uid}})).data}class Re{static SEELIE_BASE_URL="https://zzz.seelie.me";static UNIQUE_ZZZ_KEYS=["denny","w_engine","drive_disc"];static STATS_FILE_PATTERNS=[{name:"charactersStats",pattern:/stats-characters-[a-f0-9]+\.js/},{name:"weaponsStats",pattern:/stats-weapons-[a-f0-9]+\.js/},{name:"weaponsStatsCommon",pattern:/stats-weapons-common-[a-f0-9]+\.js/}];static async fetchContent(e){try{const t=await $(e);if(!t.ok)throw new Error(`请求失败，状态码: ${t.status} - ${t.statusText}`);return await t.text()}catch(t){const r=t instanceof Error?t.message:String(t);throw new Error(`获取 ${e} 时网络错误: ${r}`)}}static restoreZzzData(e){n.debug("▶️  开始从 JS 内容中还原绝区零数据...");const t=e.match(/\bexport\s*\{([\s\S]*?)\}/);if(!t)throw new Error("在JS文件中未找到 export 语句。");const r=t[1].split(",").map(a=>a.trim().split(/\s+as\s+/)[0]).filter(Boolean);let s=e.replace(/\bexport\s*\{[\s\S]*?};/,"");s+=`

// Appended by script
return { ${r.map(a=>`${a}: ${a}`).join(", ")} };`;try{const i=new Function(s)();n.debug(`🔍 正在 ${Object.keys(i).length} 个数据块中搜索绝区零数据...`);for(const c in i){const l=i[c];if(!l||typeof l!="object")continue;const d=[l.default,l];for(const u of d)if(u&&typeof u=="object"&&this.UNIQUE_ZZZ_KEYS.some(h=>h in u))return n.debug(`🎯 命中！在变量 '${c}' 中找到关键词。`),u}throw new Error("未能在任何数据块中找到绝区零的锚点关键词。")}catch(a){const i=a instanceof Error?a.message:String(a);throw new Error(`还原数据时发生错误: ${i}`)}}static parseStatsFile(e){try{const t=e.match(/\bexport\s*\{([\s\S]*?)\}/);if(!t)throw new Error("在统计文件中未找到 export 语句");const r=t[1].split(",").map(l=>l.trim()),s={};let a=null;r.forEach(l=>{const d=l.split(/\s+as\s+/);if(d.length===2){const[u,h]=d;h.trim()==="default"&&(a=u.trim()),s[h.trim()]=u.trim();}else {const u=l.trim();s[u]=u;}});let i=e.replace(/\bexport\s*\{[\s\S]*?};/,"");if(a)i+=`

// Appended by script
return ${a};`;else {const l=Object.values(s);i+=`

// Appended by script
return { ${l.map(d=>`${d}: ${d}`).join(", ")} };`;}return new Function(i)()}catch(t){const r=t instanceof Error?t.message:String(t);throw new Error(`解析统计文件时发生错误: ${r}`)}}static async processStatsFiles(e){n.debug("▶️  开始并行处理统计数据文件...");const t=this.STATS_FILE_PATTERNS.map(async({name:a,pattern:i})=>{const c=e.match(i);if(!c)return n.warn(`⚠️  未找到 ${a} 文件，跳过...`),{name:a,data:null};const l=c[0],d=`${this.SEELIE_BASE_URL}/assets/${l}`;n.debug(`📥 下载 ${a} -> ${d}`);try{const u=await this.fetchContent(d),h=this.parseStatsFile(u);return n.debug(`✅ ${a} 处理完成`),{name:a,data:h}}catch(u){const h=u instanceof Error?u.message:String(u);return n.error(`❌ 处理 ${a} 时出错: ${h}`),{name:a,data:null}}}),r=await Promise.all(t),s={};return r.forEach(({name:a,data:i})=>{i!==null&&(s[a]=i);}),n.debug(`✅ 统计数据并行处理完成，共处理 ${Object.keys(s).length} 个文件`),s}static async updateSeelieData(){try{n.debug("🚀 开始更新 Seelie 数据..."),n.debug("第一步：获取 Seelie.me 主页...");const t=(await this.fetchContent(this.SEELIE_BASE_URL)).match(/\/assets\/index-([a-f0-9]+)\.js/);if(!t)throw new Error("在主页HTML中未找到 index-....js 脚本。");const r=`${this.SEELIE_BASE_URL}${t[0]}`;n.debug(`第二步：发现主脚本 -> ${r}`);const s=await this.fetchContent(r),a=s.match(/strings-zh-([a-f0-9]+)\.js/);if(!a)throw new Error("在主脚本中未找到 strings-zh-....js 语言包。");const i=`${this.SEELIE_BASE_URL}/assets/locale/${a[0]}`;n.debug(`第三步：发现中文语言包 -> ${i}`),n.debug("🔄 开始并行处理语言包和统计数据...");const[c,l]=await Promise.all([this.fetchContent(i),this.processStatsFiles(s)]);n.debug("✅ 语言包和统计数据并行处理完成");const d=this.restoreZzzData(c);return n.debug("🎉 Seelie 数据更新完成！"),{languageData:d,statsData:l}}catch(e){const t=e instanceof Error?e.message:String(e);throw n.error(`❌ Seelie 数据更新失败: ${t}`),e}}static cacheData(e,t){try{localStorage.setItem("seelie_language_data",JSON.stringify(e)),localStorage.setItem("seelie_stats_data",JSON.stringify(t)),localStorage.setItem("seelie_data_timestamp",Date.now().toString()),n.debug("✅ 数据已缓存到 localStorage");}catch(r){n.error("❌ 缓存数据失败:",r);}}static getCachedData(){try{const e=localStorage.getItem("seelie_language_data"),t=localStorage.getItem("seelie_stats_data"),r=localStorage.getItem("seelie_data_timestamp");return !e||!t||!r?null:{languageData:JSON.parse(e),statsData:JSON.parse(t),timestamp:parseInt(r)}}catch(e){return n.error("❌ 获取缓存数据失败:",e),null}}static async getLatestData(){try{n.debug("🔄 请求最新 Seelie 数据...");const{languageData:e,statsData:t}=await this.updateSeelieData();return this.cacheData(e,t),{languageData:e,statsData:t}}catch(e){n.warn("⚠️ 网络请求失败，尝试使用缓存数据:",e);const t=this.getCachedData();if(t)return n.debug("✅ 使用缓存的 Seelie 数据"),{languageData:t.languageData,statsData:t.statsData};throw new Error("网络请求失败且无可用缓存数据")}}}const v=[1,10,20,30,40,50,60],De={0:"basic",1:"special",2:"dodge",3:"chain",5:"core",6:"assist"},ke=360;let b={};async function j(){if(!b.loaded){if(b.loading){await b.loading;return}b.loading=(async()=>{try{n.debug("🔄 懒加载 Seelie 数据...");const{languageData:o,statsData:e}=await Re.getLatestData();b.languageData=o,b.statsData=e,b.loaded=!0,n.info("✅ Seelie 数据加载完成");}catch(o){throw n.error("❌ Seelie 数据加载失败:",o),o}finally{b.loading=void 0;}})(),await b.loading;}}async function Ae(){return await j(),b.languageData}async function B(){return await j(),b.statsData}async function Te(){try{const o=await B();if(o?.charactersStats&&Array.isArray(o.charactersStats))return n.debug("✅ 使用动态角色统计数据"),o.charactersStats}catch(o){n.warn("⚠️ 获取角色统计数据失败:",o);}throw new Error("无法获取角色统计数据")}async function Me(){try{const o=await B();if(o?.weaponsStats&&typeof o.weaponsStats=="object")return n.debug("✅ 使用动态武器统计数据"),o.weaponsStats}catch(o){n.warn("⚠️ 获取武器统计数据失败:",o);}throw new Error("无法获取武器统计数据")}async function Pe(){try{const o=await B();if(o?.weaponsStatsCommon&&typeof o.weaponsStatsCommon=="object")return n.debug("✅ 使用动态武器通用统计数据"),o.weaponsStatsCommon}catch(o){n.warn("⚠️ 获取武器通用统计数据失败:",o);}throw new Error("无法获取武器通用统计数据")}class Ne{appElement=null;rootComponent=null;constructor(){this.init();}init(){if(this.appElement=document.querySelector("#app"),!this.appElement){n.warn("⚠️ SeelieCore: 未找到 #app 元素");return}if(this.appElement._vnode?.component){this.completeInit();return}this.waitForVNodeComponent();}waitForVNodeComponent(){if(!this.appElement)return;n.debug("🔍 SeelieCore: 等待 _vnode.component 出现...",this.appElement?._vnode?.component);const t=new MutationObserver(()=>{n.debug("🔍 SeelieCore: 等待 _vnode.component 出现...",this.appElement?._vnode?.component),this.appElement?._vnode?.component&&(s(),this.completeInit());});t.observe(this.appElement,{attributes:true,childList:false,subtree:false});const r=setTimeout(()=>{this.rootComponent||(s(),n.warn(`⚠️ SeelieCore: 等待 _vnode.component 超时 ${3e3/1e3}秒`));},3e3),s=()=>{t.disconnect(),clearTimeout(r);};}completeInit(){if(!this.appElement?._vnode?.component){n.warn("⚠️ SeelieCore: 完成初始化时 _vnode.component 不存在");return}this.rootComponent=this.appElement._vnode.component,j(),n.debug("✅ SeelieCore: 已尝试初始化 stats 数据"),n.log("✅ SeelieCore 初始化成功");}ensureInitialized(){return this.rootComponent||this.init(),!!this.rootComponent}getProxy(){return this.ensureInitialized()?this.rootComponent?.proxy:null}getAccountResin(){const e=this.getProxy();if(!e)return n.warn("⚠️ 无法获取组件 proxy 对象"),null;const t=e.accountResin;return n.debug("📖 获取 accountResin:",t),t}setAccountResin(e){const t=this.getProxy();if(!t)return n.warn("⚠️ 无法获取组件 proxy 对象"),false;try{const r=t.accountResin,s=this.convertToAccountResinFormat(e);return t.accountResin=s,n.debug("✏️ 设置 accountResin:",{oldValue:r,inputValue:e,convertedValue:s}),!0}catch(r){return n.error("❌ 设置 accountResin 失败:",r),false}}convertToAccountResinFormat(e){if(!e||!e.progress)throw new Error("输入参数格式错误，缺少 progress 字段");const{progress:t,restore:r}=e,s=t.current,a=t.max,i=r,c=new Date,l=(a-s)*ke,d=new Date(c.getTime()+(i-l)*1e3);return {amount:s,time:d.toString()}}setToast(e,t=""){const r=this.getProxy();if(!r)return n.warn("⚠️ 无法获取组件 proxy 对象"),false;try{return r.toast=e,r.toastType=t,n.debug("🍞 设置 Toast:",{message:e,type:t}),!0}catch(s){return n.error("❌ 设置 Toast 失败:",s),false}}addGoal(e){const t=this.getProxy();if(!t)return n.warn("⚠️ 无法获取组件 proxy 对象"),false;if(typeof t.addGoal!="function")return n.warn("⚠️ addGoal 方法不存在"),false;try{return t.addGoal(e),!0}catch(r){return n.error("❌ 调用 addGoal 失败:",r),false}}removeGoal(e){const t=this.getProxy();if(!t)return n.warn("⚠️ 无法获取组件 proxy 对象"),false;if(typeof t.removeGoal!="function")return n.warn("⚠️ removeGoal 方法不存在"),false;try{return t.removeGoal(e),!0}catch(r){return n.error("❌ 调用 removeGoal 失败:",r),false}}setInventory(e,t,r,s){const a=this.getProxy();if(!a)return n.warn("⚠️ 无法获取组件 proxy 对象"),false;if(typeof a.setInventory!="function")return n.warn("⚠️ setInventory 方法不存在"),false;try{return a.setInventory(e,t,r,s),!0}catch(i){return n.error("❌ 调用 setInventory 失败:",i),false}}getCharacters(){return this.getProxy()?.characters||{}}getWeapons(){return this.getProxy()?.weapons||{}}getGoals(){return this.getProxy()?.goals||[]}getItems(){return this.getProxy()?.items||{}}getContextInfo(){const e=this.getProxy();return e?{keys:Object.keys(e),accountResin:e.accountResin,hasAccountResin:"accountResin"in e,contextType:typeof e}:null}refresh(){n.debug("🔄 SeelieCore 重新初始化..."),this.appElement=null,this.rootComponent=null,this.init();}}async function Oe(o){try{const t=(await Te()).find(u=>u.id===o.id);if(!t)return n.warn(`⚠️ 未找到角色 ${o.name_mi18n} 的统计数据`),v.findIndex(u=>u>=o.level);const r=o.properties.find(u=>u.property_id===1);if(!r)return n.warn(`⚠️ 角色 ${o.name_mi18n} 缺少生命值属性`),v.findIndex(u=>u>=o.level);const s=parseInt(r.base||r.final),a=t.base,i=(o.level-1)*t.growth/1e4,c=o.skills.find(u=>u.skill_type===5),l=c&&t.core&&t.core[c.level-2]||0,d=a+i+l;for(let u=0;u<t.ascHP.length;u++){const h=t.ascHP[u];if(Math.floor(d+h)===s)return u}return n.debug(`HP error: ${o.name_mi18n}, base: ${a}, growth: ${i}, core: ${l}, fixed: ${d}, target: ${s}`),v.findIndex(u=>u>=o.level)}catch(e){return n.error("❌ 计算角色突破等级失败:",e),v.findIndex(t=>t>=o.level)}}async function Le(o){try{const e=await Pe(),t=await Me(),r=e.rate[o.level]||0,s=o.main_properties.find(d=>d.property_id===12101);if(!s)return n.warn(`⚠️ 武器 ${o.name} 缺少攻击力属性`),v.findIndex(d=>d>=o.level);const a=parseInt(s.base),i=t[o.id]||48,c=i*r/1e4,l=i+c;for(let d=0;d<e.ascRate.length;d++){const u=e.ascRate[d],h=i*u/1e4;if(Math.floor(l+h)===a)return d}return n.debug(`ATK error: ${o.name}, base: ${i}, growth: ${c}, fixed: ${l}, target: ${a}`),v.findIndex(d=>d>=o.level)}catch(e){return n.error("❌ 计算武器突破等级失败:",e),v.findIndex(t=>t>=o.level)}}function Ue(o,e,t){let r=o;return e==="core"?r--:t>=5?r-=4:t>=3&&(r-=2),Math.max(1,r)}class je extends Ne{async setCharacter(e){try{const t=e.avatar||e,r=this.findCharacterKey(t.id);if(!r)throw new Error("Character not found.");const s=this.findExistingGoal(r,"character"),a=await Oe(t),i=s;let c=i?.goal?.level;(!c||c<t.level)&&(c=t.level);let l=i?.goal?.asc;(!l||l<a)&&(l=a);const d={type:"character",character:r,cons:t.rank,current:{level:t.level,asc:a},goal:{level:c||t.level,asc:l||a}};return this.addGoal(d)?(n.debug("✓ 角色数据设置成功:",{character:r,level:t.level,rank:t.rank,currentAsc:a,targetLevel:c,targetAsc:l}),!0):!1}catch(t){return n.error("❌ 设置角色数据失败:",t),false}}setTalents(e){try{const t=e.avatar||e,r=this.findCharacterKey(t.id);if(!r)throw new Error("Character not found.");const s=this.findExistingGoal(r,"talent"),a={};t.skills.forEach(c=>{const l=De[c.skill_type];if(!l)return;const d=Ue(c.level,l,t.rank);let h=s?.[l]?.goal;(!h||h<d)&&(h=d),a[l]={current:d,goal:h||d};});const i={type:"talent",character:r,...a};return this.addGoal(i)?(n.debug("✓ 角色天赋数据设置成功:",{character:r,talents:a}),!0):!1}catch(t){return n.error("❌ 设置角色天赋数据失败:",t),false}}async setWeapon(e){try{const t=e.avatar||e,r=e.weapon,s=this.findCharacterKey(t.id);if(!s)throw new Error("Character not found.");const a=this.findExistingGoal(s,"weapon");if(!r)return a&&this.removeGoal(a)&&n.debug("✓ 移除武器目标成功"),!0;const i=this.findWeaponKey(r.id);if(!i)throw new Error("Weapon not found.");const c=await Le(r),l={level:r.level,asc:c};let d={level:l.level,asc:l.asc};const u=this.getWeapons(),h=a,g=h?.weapon?u[h.weapon]:null,p=u[i];g?.id===p?.id&&h?.goal?(d.level=Math.max(h.goal.level||l.level,l.level),d.asc=Math.max(h.goal.asc||l.asc,l.asc),p.craftable&&(l.craft=r.star,d.craft=Math.max(h.goal.craft||r.star,r.star))):p.craftable&&(l.craft=r.star,d.craft=r.star);const m={type:"weapon",character:s,weapon:i,current:l,goal:d};return this.addGoal(m)?(n.debug("✓ 武器数据设置成功:",{character:s,weapon:i,current:l,goal:d}),!0):!1}catch(t){return n.error("❌ 设置武器数据失败:",t),false}}async syncCharacter(e){const t={success:0,failed:0,errors:[]},r=e.avatar||e,s=r.name_mi18n||`角色ID:${r.id}`;n.debug(`🔄 开始同步角色: ${s}`);const i=[{name:"角色数据",fn:()=>this.setCharacter(e)},{name:"天赋数据",fn:()=>this.setTalents(e)},{name:"武器数据",fn:()=>this.setWeapon(e)}].map(async({name:l,fn:d})=>{try{return await d()?(n.debug(`✓ ${s} - ${l}同步成功`),{success:!0,error:null}):{success:!1,error:`${s} - ${l}同步失败`}}catch(u){const h=`${s} - ${l}同步错误: ${u}`;return n.error(`❌ ${h}`),{success:false,error:h}}});return (await Promise.all(i)).forEach(({success:l,error:d})=>{l?t.success++:(t.failed++,d&&t.errors.push(d));}),n.debug(`✅ ${s} 同步完成 - 成功: ${t.success}, 失败: ${t.failed}`),t}async syncAllCharacters(e){const t={total:e.length,success:0,failed:0,errors:[],details:[]};n.debug(`🚀 开始批量同步 ${e.length} 个角色`);const r=e.map(async(a,i)=>{const c=a.avatar||a,l=c.name_mi18n||`角色ID:${c.id}`;n.debug(`📝 [${i+1}/${e.length}] 同步角色: ${l}`);try{const d=await this.syncCharacter(a);return {character:l,result:d,success:d.failed===0}}catch(d){const u=`${l} - 批量同步失败: ${d}`;return n.error(`❌ ${u}`),{character:l,result:{success:0,failed:1,errors:[u]},success:false}}});return (await Promise.all(r)).forEach(({character:a,result:i,success:c})=>{t.details.push({character:a,result:i}),c?t.success++:(t.failed++,t.errors.push(...i.errors));}),this.logBatchResult(t),t}findCharacterKey(e){const t=this.getCharacters();return Object.keys(t).find(r=>t[r].id===e)||null}findWeaponKey(e){const t=this.getWeapons();return Object.keys(t).find(r=>t[r].id===e)||null}findExistingGoal(e,t){return this.getGoals().find(s=>{const a=s;return a.character===e&&a.type===t})}logBatchResult(e){n.debug("🎯 批量同步完成:"),n.debug(`   总计: ${e.total} 个角色`),n.debug(`   成功: ${e.success} 个角色`),n.debug(`   失败: ${e.failed} 个角色`),e.errors.length>0&&(n.debug("   错误详情:"),e.errors.forEach(t=>n.debug(`     - ${t}`)));}_minimumSetCoverCache=null;_minimumSetWeaponsCache=null;findMinimumSetCoverIds(){if(this._minimumSetCoverCache!==null)return n.debug("📦 使用缓存的最小集合覆盖结果"),this._minimumSetCoverCache;const e=this.getCharacters(),t=Object.values(e),r=new Set;for(const c of t)r.add(c.attribute),r.add(c.style),r.add(c.boss),r.add(c.boss_weekly);const s=new Set(r),a=[],i=new Set;for(;s.size>0;){let c=null,l=0;for(const u of t){if(i.has(u.id)||new Date(u.release)>new Date)continue;const h=new Set([u.attribute,u.style,u.boss,u.boss_weekly]);let g=0;for(const p of h)s.has(p)&&g++;g>l&&(l=g,c=u);}if(c===null){n.warn("⚠️ 无法覆盖所有属性，可能缺少某些属性的组合");break}a.push({id:c.id,style:c.style}),i.add(c.id);const d=new Set([c.attribute,c.style,c.boss,c.boss_weekly]);for(const u of d)s.delete(u);n.debug(`✅ 选择角色 ${c.id}，覆盖 ${l} 个属性`);}return n.debug(`🎯 最小集合覆盖完成，共选择 ${a.length} 个角色: ${a.join(", ")}`),this._minimumSetCoverCache=a,a}findMinimumSetWeapons(){if(this._minimumSetWeaponsCache!==null)return n.debug("📦 使用缓存的最小武器集合结果"),this._minimumSetWeaponsCache;const e=this.getWeapons(),t=Object.values(e),r={};for(const s of t)s.tier===5&&!r[s.style]&&new Date>=new Date(s.release)&&(r[s.style]=s.id);return this._minimumSetWeaponsCache=r,r}}class Be extends je{}const x=new Be,He=o=>x.setAccountResin(o),f=(o,e="success")=>x.setToast(o,e),Ge=async o=>await x.syncCharacter(o),Fe=async o=>await x.syncAllCharacters(o),V=(o,e,t,r)=>x.setInventory(o,e,t,r),ze=()=>x.findMinimumSetCoverIds(),Ve=()=>x.findMinimumSetWeapons(),We=()=>x.getItems();var O=(o=>(o[o.NormalAttack=0]="NormalAttack",o[o.SpecialSkill=1]="SpecialSkill",o[o.Dodge=2]="Dodge",o[o.Chain=3]="Chain",o[o.CorePassive=5]="CorePassive",o[o.SupportSkill=6]="SupportSkill",o))(O||{});async function Ke(o,e,t,r){const s=await T(t,r),a={avatar_id:Number(o),avatar_level:v[v.length-1],avatar_current_level:1,avatar_current_promotes:1,skills:Object.values(O).filter(c=>typeof c!="string").map(c=>({skill_type:c,level:c===O.CorePassive?7:12,init_level:1})),weapon_info:{weapon_id:Number(e),weapon_level:v[v.length-1],weapon_promotes:0,weapon_init_level:0}};return (await A("/user/avatar_calc",k,{method:"POST",params:{uid:s.uid,region:s.region},body:a})).data}async function qe(o,e,t){const r=o.map(s=>Ke(s.avatar_id,s.weapon_id,e,t));return await Promise.all(r)}class Je{async syncResinData(){try{n.debug("🔋 开始同步电量数据...");const e=await Ie();if(!e)return n.error("❌ 获取游戏便笺失败"),f("获取游戏便笺失败","error"),!1;const t=e.energy,r=He(t);return r?(n.debug("✅ 电量数据同步成功"),f(`电量同步成功: ${t.progress.current}/${t.progress.max}`,"success")):(n.error("❌ 电量数据设置失败"),f("电量数据设置失败","error")),r}catch(e){return n.error("❌ 电量数据同步失败:",e),f("电量数据同步失败","error"),false}}async syncSingleCharacter(e){try{n.debug(`👤 开始同步角色数据: ${e}`);const t=await z([e],void 0);if(!t||t.length===0){const a="获取角色详细信息失败";return n.error(`❌ ${a}`),f(a,"error"),{success:0,failed:1,errors:[a]}}const r=t[0],s=await Ge(r);return s.success>0?(n.debug(`✅ 角色 ${r.avatar.name_mi18n} 同步成功`),f(`角色 ${r.avatar.name_mi18n} 同步成功`,"success")):(n.error(`❌ 角色 ${r.avatar.name_mi18n} 同步失败`),f(`角色 ${r.avatar.name_mi18n} 同步失败`,"error")),s}catch(t){const r=`角色 ${e} 同步失败`;return n.error(`❌ ${r}:`,t),f(r,"error"),{success:0,failed:1,errors:[String(t)]}}}async syncAllCharacters(){try{n.debug("👥 开始同步所有角色数据...");const e=await $e();if(!e||e.length===0){const a="获取角色列表失败或角色列表为空";return n.error(`❌ ${a}`),f(a,"error"),{success:0,failed:1,errors:[a],total:0,details:[]}}n.debug(`📋 找到 ${e.length} 个角色`),f(`开始同步 ${e.length} 个角色...`,"");const t=e.map(a=>a.avatar.id),r=await z(t,void 0);if(!r||r.length===0){const a="获取角色详细信息失败";return n.error(`❌ ${a}`),f(a,"error"),{success:0,failed:1,errors:[a],total:0,details:[]}}const s=await Fe(r);return s.success>0?(n.debug(`✅ 所有角色同步完成: 成功 ${s.success}，失败 ${s.failed}`),f(`角色同步完成: 成功 ${s.success}，失败 ${s.failed}`,"success")):(n.error("❌ 角色批量同步失败"),f("角色批量同步失败","error")),s}catch(e){const t="所有角色同步失败";return n.error(`❌ ${t}:`,e),f(t,"error"),{success:0,failed:1,errors:[String(e)],total:0,details:[]}}}async syncItemsData(){try{n.debug("🔋 开始始同步养成材料数据...");const e=ze(),t=Ve(),r=e.map(m=>({avatar_id:m.id,weapon_id:t[m.style]})),s=await qe(r);if(!s){const m="获取养成材料数据失败";return n.error(`❌ ${m}`),f(m,"error"),!1}const a=this.collectAllItemsInfo(s),i=this.buildItemsInventory(s,a),c=We();c.denny={type:"denny"};const l=await Ae();if(!l){const m="获取语言数据失败";return n.error(`❌ ${m}`),f(m,"error"),!1}const d=this.buildCnToSeelieNameMapping(l),{successNum:u,failNum:h}=this.syncItemsToSeelie(i,d,c),g=u>0,p=u+h;if(g){n.debug(`✅ 养成材料同步成功: ${u}/${p}`);const m=h===0?"success":"warning";f(`养成材料同步成功: ${u}/${p}`,m);}else n.error("❌ 养成材料同步失败"),f("养成材料同步失败","error");return g}catch(e){const t="养成材料同步失败";return n.error(`❌ ${t}:`,e),f(t,"error"),false}}collectAllItemsInfo(e){const t={};for(const r of e){const s=[...r.avatar_consume,...r.weapon_consume,...r.skill_consume,...r.need_get];for(const a of s){const i=a.id.toString();i in t||(t[i]={id:a.id,name:a.name});}}return t}buildItemsInventory(e,t){const r={},s={};for(const a of e)Object.assign(s,a.user_owns_materials);for(const[a,i]of Object.entries(t)){const c=s[a]||0;r[i.name]=c;}return r}buildCnToSeelieNameMapping(e){const t={};for(const[r,s]of Object.entries(e))typeof s=="string"?t[s]=r:Array.isArray(s)&&s.forEach((a,i)=>{t[a]=`${r}+${i}`;});return t}syncItemsToSeelie(e,t,r){let s=0,a=0;for(const[i,c]of Object.entries(e)){const l=t[i];if(!l){a++;continue}try{const d=l.split("+");if(d.length>1){const u=d[0],h=Number(d[1]),g=r[u].type;g&&V(g,u,h,c)?s++:a++;}else {const u=r[l]?.type;u&&V(u,l,0,c)?s++:a++;}}catch{a++;}}return {successNum:s,failNum:a}}async syncAll(){n.debug("🚀 开始执行完整同步..."),f("开始执行完整同步...","");const[e,t,r]=await Promise.all([this.syncResinData(),this.syncAllCharacters(),this.syncItemsData()]),s=e&&t.success>0&&r,a=s?"完整同步成功":"完整同步部分失败";return n.debug(`${s?"✅":"⚠️"} ${a}`),f(a,s?"success":"error"),{resinSync:e,characterSync:t,itemsSync:r}}}const M=new Je,Ze=()=>M.syncResinData(),Ye=()=>M.syncAllCharacters(),Qe=()=>M.syncItemsData(),Xe=()=>M.syncAll(),W="https://www.miyoushe.com/zzz/";class S{container=null;userInfo=null;isLoading=false;isExpanded=false;static TARGET_SELECTOR="div.flex.flex-col.items-center.justify-center.w-full.mt-3";static PANEL_SELECTOR='[data-seelie-panel="true"]';constructor(){}async init(){try{await this.createPanel();}catch(e){throw n.error("初始化 Seelie 面板失败:",e),e}}async createPanel(){const e=document.querySelector(S.TARGET_SELECTOR);if(!e)throw new Error("目标容器未找到");const t=e.querySelector(S.PANEL_SELECTOR);if(t&&(t.remove(),n.debug("清理了目标容器中的旧面板")),this.container&&e.contains(this.container)){n.debug("面板已存在，跳过创建");return}await this.loadUserInfo(),this.container=this.createPanelElement(),e.insertBefore(this.container,e.firstChild),n.info("✅ Seelie 面板创建成功");}async loadUserInfo(){try{this.userInfo=await Se(),n.debug("用户信息加载成功:",this.userInfo);}catch(e){n.error("加载用户信息失败:",e),this.userInfo=null;const t=String(e);t.includes("获取用户角色失败")||t.includes("HTTP 401")||t.includes("HTTP 403")?this.userInfo={error:"login_required",message:"请先登录米游社账号"}:t.includes("未找到绝区零游戏角色")?this.userInfo={error:"no_character",message:"未找到绝区零游戏角色"}:t.includes("网络")||t.includes("timeout")||t.includes("fetch")?this.userInfo={error:"network_error",message:"网络连接失败，请重试"}:this.userInfo={error:"unknown",message:"用户信息加载失败"};}}createPanelElement(){const e=document.createElement("div");e.className="w-full mb-3 p-3 bg-gray-800 rounded-lg border border-gray-200/20",e.setAttribute("data-seelie-panel","true");const t=this.createUserInfoSection(),r=this.createSyncSection();return e.appendChild(t),e.appendChild(r),e}createUserInfoSection(){const e=document.createElement("div");e.className="flex flex-col items-center justify-center mb-3";const t=document.createElement("div");if(t.className="flex flex-col items-center text-center",this.userInfo&&!("error"in this.userInfo)){const r=document.createElement("div");r.className="text-sm font-medium text-white",r.textContent=this.userInfo.nickname;const s=document.createElement("div");s.className="text-xs text-gray-400",s.textContent=`UID: ${this.userInfo.uid}`,t.appendChild(r),t.appendChild(s);}else if(this.userInfo&&"error"in this.userInfo){const r=this.userInfo,s=document.createElement("div");s.className="flex flex-col items-center";const a=document.createElement("div");a.className="text-red-400 mb-2",a.innerHTML=`
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
      `;const i=document.createElement("div");if(i.className="text-sm text-red-400 mb-2",i.textContent=r.message,s.appendChild(a),s.appendChild(i),r.error==="login_required"){const c=document.createElement("div");c.className="text-xs text-gray-400 mb-2 text-center",c.textContent="请在新标签页中登录米游社后刷新页面";const l=document.createElement("button");l.className="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-all duration-200",l.textContent="前往米游社登录",l.addEventListener("click",()=>{window.open(W,"_blank");}),s.appendChild(c),s.appendChild(l);}else if(r.error==="no_character"){const c=document.createElement("div");c.className="text-xs text-gray-400 mb-2 text-center",c.textContent="请先在米游社绑定绝区零游戏角色";const l=document.createElement("button");l.className="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded transition-all duration-200",l.textContent="前往绑定角色",l.addEventListener("click",()=>{window.open(W,"_blank");}),s.appendChild(c),s.appendChild(l);}else if(r.error==="network_error"){const c=document.createElement("button");c.className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded transition-all duration-200",c.textContent="重试",c.addEventListener("click",()=>this.refreshUserInfo()),s.appendChild(c);}else {const c=document.createElement("button");c.className="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded transition-all duration-200",c.textContent="重试",c.addEventListener("click",()=>this.refreshUserInfo()),s.appendChild(c);}t.appendChild(s);}else {const r=document.createElement("div");r.className="text-sm text-red-400",r.textContent="用户信息加载失败",t.appendChild(r);}return e.appendChild(t),e}createSyncSection(){const e=document.createElement("div");e.className="flex flex-col items-center";const t=this.userInfo&&!("error"in this.userInfo),r=t?"":" opacity-50 cursor-not-allowed",s=t?"bg-gray-700 hover:bg-gray-600":"bg-gray-800",a=document.createElement("button");a.className=`flex items-center justify-center px-6 py-2 ${s} text-white font-medium rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed mb-2${r}`,a.disabled=!t,a.innerHTML=`
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
      </svg>
      <span class="sync-text">${t?"同步全部":"请先登录"}</span>
    `;const i=document.createElement("button");i.className=`flex items-center justify-center px-4 py-1 ${t?"bg-gray-600 hover:bg-gray-500":"bg-gray-700"} text-white text-sm rounded transition-all duration-200${r}`,i.disabled=!t,i.innerHTML=`
      <span class="mr-1 text-xs">更多选项</span>
      <svg class="w-3 h-3 expand-icon transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    `,t&&(a.addEventListener("click",()=>this.handleSyncAll(a)),i.addEventListener("click",()=>this.toggleExpanded(i)));const c=document.createElement("div");c.className="w-full mt-2 overflow-hidden transition-all duration-300",c.style.maxHeight="0",c.style.opacity="0";const l=this.createDetailedSyncOptions();return c.appendChild(l),e.appendChild(a),e.appendChild(i),e.appendChild(c),e}createDetailedSyncOptions(){const e=document.createElement("div");e.className="grid grid-cols-2 gap-2";const t=this.userInfo&&!("error"in this.userInfo);return [{text:"同步电量",icon:`<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>`,handler:s=>this.handleSyncResin(s)},{text:"同步角色",icon:`<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>`,handler:s=>this.handleSyncCharacters(s)},{text:"同步材料",icon:`<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
        </svg>`,handler:s=>this.handleSyncItems(s)},{text:"重置设备",icon:`<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15M12 3v9m0 0l-3-3m3 3l3-3"></path>
        </svg>`,handler:s=>this.handleResetDeviceInfo(s)}].forEach(s=>{const a=document.createElement("button"),i=t?"bg-gray-600 hover:bg-gray-500":"bg-gray-700 opacity-50 cursor-not-allowed";a.className=`flex items-center justify-center px-3 py-2 ${i} text-white text-sm font-medium rounded transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed`,a.disabled=!t,a.innerHTML=`${s.icon}<span class="sync-text">${s.text}</span>`,t&&a.addEventListener("click",s.handler),e.appendChild(a);}),e}toggleExpanded(e){if(this.isLoading)return;this.isExpanded=!this.isExpanded;const t=this.container?.querySelector(".overflow-hidden"),r=e.querySelector(".expand-icon");this.isExpanded?(t.style.maxHeight="200px",t.style.opacity="1",r.style.transform="rotate(180deg)"):(t.style.maxHeight="0",t.style.opacity="0",r.style.transform="rotate(0deg)");}async handleSyncAll(e){this.isLoading||!e&&(e=this.container?.querySelector(".sync-text")?.closest("button"),!e)||await this.performSyncOperation(e,"同步中...",async()=>{n.debug("开始同步全部数据..."),await this.performSync(),n.debug("✅ 同步完成");});}async handleSyncResin(e){const t=e?.target?.closest("button");t&&await this.performSyncOperation(t,"同步中...",async()=>{if(n.debug("开始同步电量数据..."),!await Ze())throw new Error("电量同步失败");n.debug("✅ 电量同步完成");});}async handleSyncCharacters(e){const t=e?.target?.closest("button");t&&await this.performSyncOperation(t,"同步中...",async()=>{if(n.debug("开始同步角色数据..."),(await Ye()).success===0)throw new Error("角色同步失败");n.debug("✅ 角色同步完成");});}async handleSyncItems(e){const t=e?.target?.closest("button");t&&await this.performSyncOperation(t,"同步中...",async()=>{if(n.debug("开始同步材料数据..."),!await Qe())throw new Error("材料同步失败");n.debug("✅ 材料同步完成");});}async handleResetDeviceInfo(e){const t=e?.target?.closest("button");t&&await this.performSyncOperation(t,"重置中...",async()=>{n.debug("开始重置设备信息...");try{await Ee(),n.debug("✅ 设备信息重置完成"),f("设备信息已重置","success");}catch(r){n.error("设备信息重置失败:",r),f("设备信息重置失败","error");}});}async performSyncOperation(e,t,r){if(this.isLoading)return;this.isLoading=true;const s=e.querySelector(".sync-text"),a=s.textContent;try{this.setAllButtonsDisabled(!0),s.textContent=t;const i=e.querySelector("svg");i&&i.classList.add("animate-spin"),await r(),this.showSyncResult(e,s,a,i,"success");}catch(i){n.error("同步失败:",i);const c=e.querySelector("svg");this.showSyncResult(e,s,a,c,"error");}}async performSync(){try{n.debug("开始执行完整同步...");const e=await Xe(),{resinSync:t,characterSync:r,itemsSync:s}=e;if(!(t&&r.success>0&&s)){const i=[];if(t||i.push("电量同步失败"),r.success===0){const l=r.errors||["角色同步失败"];i.push(...l);}s||i.push("养成材料同步失败");const c=i.length>0?i.join(", "):"同步过程中出现错误";throw new Error(c)}n.info(`✅ 同步完成 - 电量: ${t?"成功":"失败"}, 角色: ${r.success}/${r.total}, 养成材料: ${s?"成功":"失败"}`);}catch(e){throw n.error("同步操作失败:",e),e}}setAllButtonsDisabled(e){if(!this.container)return;this.container.querySelectorAll("button").forEach(r=>{r.disabled=e;});}showSyncResult(e,t,r,s,a){const i=a==="success";t.textContent=i?"同步完成":"同步失败";const c=e.className.match(/bg-gray-\d+/)?.[0]||"bg-gray-700",l=e.className.match(/hover:bg-gray-\d+/)?.[0]||"hover:bg-gray-600",d=i?"bg-green-600":"bg-red-600",u=i?"hover:bg-green-700":"hover:bg-red-700";e.className=e.className.replace(c,d).replace(l,u),setTimeout(()=>{t.textContent=r||"同步全部",e.className=e.className.replace(d,c).replace(u,l),s&&s.classList.remove("animate-spin"),this.setAllButtonsDisabled(false),this.isLoading=false;},2e3);}destroy(){this.container&&this.container.parentNode&&(this.container.parentNode.removeChild(this.container),this.container=null),document.querySelectorAll(S.PANEL_SELECTOR).forEach(t=>{t.parentNode&&t.parentNode.removeChild(t);}),n.debug("Seelie 面板已销毁");}async refresh(){await this.refreshUserInfo();}async refreshUserInfo(){try{await this.loadUserInfo(),this.container&&this.container.parentNode&&(this.destroy(),await this.createPanel());}catch(e){n.error("刷新用户信息失败:",e);}}}function et(){const o={id:"seelie-panel",targetSelector:S.TARGET_SELECTOR,componentSelector:S.PANEL_SELECTOR,condition:()=>true};N.register(o,()=>new S),n.debug("📝 Seelie 面板组件注册完成");}const tt={seeliePanel:et};function rt(){n.debug("🎯 开始注册所有组件"),Object.values(tt).forEach(o=>o()),n.debug("✅ 所有组件注册完成");}function nt(){n.log("🎯 zzz-seelie-sync 脚本已加载"),st();}function st(){try{if(N.isInit()){n.debug("DOM 注入管理器已初始化，跳过");return}rt(),N.init(),n.debug("✅ DOM 注入管理器初始化完成");}catch(o){n.error("❌ 初始化 DOM 注入管理器失败:",o);}}nt();

})();